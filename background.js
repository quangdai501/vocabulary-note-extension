const s={DAILY_REVIEW:"daily-review",CHECK_INTERVAL:1440},r={VOCABULARY:"vocabulary",SETTINGS:"settings",STATS:"stats"};chrome.runtime.onInstalled.addListener(async e=>{e.reason==="install"?(console.log("Vocabulary Note installed"),await u(),c(),await m()):e.reason==="update"&&(console.log("Vocabulary Note updated"),await u(),c())});chrome.runtime.onStartup.addListener(()=>{console.log("Vocabulary Note extension started"),c()});chrome.alarms.onAlarm.addListener(async e=>{e.name===s.DAILY_REVIEW&&await l()});chrome.commands.onCommand.addListener(async e=>{if(e==="save-word"){const[t]=await chrome.tabs.query({active:!0,currentWindow:!0});t!=null&&t.id&&chrome.tabs.sendMessage(t.id,{action:"saveSelectedWord"})}});chrome.contextMenus.onClicked.addListener(async(e,t)=>{e.menuItemId==="save-word"&&e.selectionText&&t!=null&&t.id&&chrome.tabs.sendMessage(t.id,{action:"saveWord",word:e.selectionText.trim()})});chrome.runtime.onMessage.addListener((e,t,n)=>{if(e.action==="playPronunciation")h(e.word,e.audioUrl),n({success:!0});else if(e.action==="checkDueWords")return l().then(i=>{n({dueCount:i})}),!0});async function u(){try{await chrome.alarms.clear(s.DAILY_REVIEW);const t=(await d()).dailyReminderTime||"09:00",[n,i]=t.split(":").map(Number),a=new Date,o=new Date;o.setHours(n,i,0,0),o<=a&&o.setDate(o.getDate()+1),await chrome.alarms.create(s.DAILY_REVIEW,{when:o.getTime(),periodInMinutes:s.CHECK_INTERVAL}),console.log("Daily alarm set for:",o)}catch(e){console.error("Error setting up alarm:",e)}}async function l(){try{const t=(await chrome.storage.local.get(r.VOCABULARY))[r.VOCABULARY]||[],n=Date.now(),a=t.filter(o=>!o.nextReview||o.nextReview<=n).length;return a>0&&(await d()).showNotifications!==!1&&await chrome.notifications.create({type:"basic",iconUrl:"../icons/icon128.png",title:"Vocabulary Review",message:`You have ${a} word${a>1?"s":""} to review today!`,priority:2,buttons:[{title:"Review Now"}]}),a}catch(e){return console.error("Error checking due words:",e),0}}chrome.notifications.onButtonClicked.addListener((e,t)=>{t===0&&chrome.action.openPopup(),chrome.notifications.clear(e)});function c(){chrome.contextMenus.removeAll(()=>{chrome.contextMenus.create({id:"save-word",title:'Save "%s" to Vocabulary',contexts:["selection"]})})}async function m(){try{const e=await chrome.storage.local.get([r.SETTINGS,r.VOCABULARY]);e[r.SETTINGS]||await chrome.storage.local.set({[r.SETTINGS]:{dailyReminderTime:"09:00",autoPlayPronunciation:!1,showNotifications:!0}}),e[r.VOCABULARY]||await chrome.storage.local.set({[r.VOCABULARY]:[]})}catch(e){console.error("Error initializing storage:",e)}}async function d(){try{return(await chrome.storage.local.get(r.SETTINGS))[r.SETTINGS]||{dailyReminderTime:"09:00",autoPlayPronunciation:!1,showNotifications:!0}}catch(e){return console.error("Error getting settings:",e),{}}}async function h(e,t){console.log("Pronunciation request:",e)}chrome.runtime.onStartup.addListener(async()=>{await l()});console.log("Vocabulary Note background script loaded");
