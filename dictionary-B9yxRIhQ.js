const h={DICTIONARY:"https://api.dictionaryapi.dev/api/v2/entries/en/",YOUGLISH_BASE:"https://youglish.com/pronounce/"},c={VOCABULARY:"vocabulary",SETTINGS:"settings",STATS:"stats"},a={MIN_EASE_FACTOR:1.3,INITIAL_EASE_FACTOR:2.5,INITIAL_INTERVAL:1,EASY_BONUS:1.3,HARD_INTERVAL:.5,QUALITY_HARD:3,QUALITY_GOOD:4,QUALITY_EASY:5};class w{async getAllVocabulary(){try{return(await chrome.storage.local.get(c.VOCABULARY))[c.VOCABULARY]||[]}catch(t){return console.error("Error getting vocabulary:",t),[]}}async saveWord(t){try{const e=await this.getAllVocabulary(),r=e.findIndex(n=>n.word.toLowerCase()===t.word.toLowerCase());return r!==-1?e[r]={...e[r],...t,updatedAt:Date.now()}:e.push({...t,id:this.generateId(),createdAt:Date.now(),updatedAt:Date.now()}),await chrome.storage.local.set({[c.VOCABULARY]:e}),!0}catch(e){return console.error("Error saving word:",e),!1}}async updateWordSRS(t,e){try{const r=await this.getAllVocabulary(),n=r.findIndex(i=>i.id===t);return n===-1?!1:(r[n]={...r[n],...e,lastReview:Date.now(),updatedAt:Date.now()},await chrome.storage.local.set({[c.VOCABULARY]:r}),!0)}catch(r){return console.error("Error updating word SRS:",r),!1}}async updateWord(t){try{const e=await this.getAllVocabulary(),r=e.findIndex(n=>n.id===t.id);return r===-1?!1:(e[r]={...e[r],...t,updatedAt:Date.now()},await chrome.storage.local.set({[c.VOCABULARY]:e}),!0)}catch(e){return console.error("Error updating word:",e),!1}}async deleteWord(t){try{const r=(await this.getAllVocabulary()).filter(n=>n.id!==t);return await chrome.storage.local.set({[c.VOCABULARY]:r}),!0}catch(e){return console.error("Error deleting word:",e),!1}}async getDueWords(){try{const t=await this.getAllVocabulary(),e=Date.now();return t.filter(r=>!r.nextReview||r.nextReview<=e)}catch(t){return console.error("Error getting due words:",t),[]}}async exportVocabulary(){const t=await this.getAllVocabulary();return JSON.stringify(t,null,2)}async importVocabulary(t){try{const e=JSON.parse(t),n=[...await this.getAllVocabulary()];return e.forEach(i=>{n.findIndex(o=>o.word.toLowerCase()===i.word.toLowerCase())===-1&&n.push({...i,id:this.generateId(),importedAt:Date.now()})}),await chrome.storage.local.set({[c.VOCABULARY]:n}),!0}catch(e){return console.error("Error importing vocabulary:",e),!1}}async getStats(){const t=await this.getAllVocabulary(),e=await this.getDueWords();return{totalWords:t.length,dueToday:e.length,reviewedToday:t.filter(r=>{if(!r.lastReview)return!1;const n=new Date().setHours(0,0,0,0);return r.lastReview>=n}).length}}generateId(){return`word_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}async getSettings(){try{return(await chrome.storage.local.get(c.SETTINGS))[c.SETTINGS]||{dailyLimit:50,newWordsPerDay:10,showNotifications:!0,dailyReminderTime:"09:00"}}catch(t){return console.error("Error getting settings:",t),{dailyLimit:50,newWordsPerDay:10,showNotifications:!0,dailyReminderTime:"09:00"}}}async saveSettings(t){try{return await chrome.storage.local.set({[c.SETTINGS]:t}),!0}catch(e){return console.error("Error saving settings:",e),!1}}async resetProgress(){try{const e=(await this.getAllVocabulary()).map(r=>({...r,easeFactor:2.5,interval:1,repetitions:0,nextReview:null,lastReview:null,updatedAt:Date.now()}));return await chrome.storage.local.set({[c.VOCABULARY]:e}),!0}catch(t){return console.error("Error resetting progress:",t),!1}}}const g=new w;class y{calculateNextReview(t,e){const{repetition:r=0,easeFactor:n=a.INITIAL_EASE_FACTOR,interval:i=a.INITIAL_INTERVAL}=t;let s=r,o=i,l=n;l=this.calculateEaseFactor(n,e),e<a.QUALITY_HARD?(s=0,o=1):(s=r+1,s===1?o=1:s===2?o=6:o=Math.round(i*l),e===a.QUALITY_HARD?o=Math.max(1,Math.round(o*a.HARD_INTERVAL)):e===a.QUALITY_EASY&&(o=Math.round(o*a.EASY_BONUS)));const d=Date.now()+o*24*60*60*1e3;return{repetition:s,interval:o,easeFactor:l,nextReview:d,lastReview:Date.now()}}calculateEaseFactor(t,e){const r=t+(.1-(5-e)*(.08+(5-e)*.02));return Math.max(a.MIN_EASE_FACTOR,r)}getQualityScore(t){return{hard:a.QUALITY_HARD,good:a.QUALITY_GOOD,easy:a.QUALITY_EASY}[t.toLowerCase()]||a.QUALITY_GOOD}formatInterval(t){if(t<1)return"Less than 1 day";if(t===1)return"1 day";if(t<30)return`${t} days`;if(t<365){const e=Math.floor(t/30);return`${e} ${e===1?"month":"months"}`}else{const e=Math.floor(t/365);return`${e} ${e===1?"year":"years"}`}}isDue(t){return t.nextReview?Date.now()>=t.nextReview:!0}getPredictedIntervals(t){const e=this.calculateNextReview(t,a.QUALITY_HARD),r=this.calculateNextReview(t,a.QUALITY_GOOD),n=this.calculateNextReview(t,a.QUALITY_EASY);return{hard:this.formatInterval(e.interval),good:this.formatInterval(r.interval),easy:this.formatInterval(n.interval)}}initializeWord(){return{repetition:0,interval:0,easeFactor:a.INITIAL_EASE_FACTOR,nextReview:null,lastReview:null}}}const I=new y;class f{constructor(){this.currentAudio=null}async playPronunciation(t,e=""){try{return this.stopCurrentAudio(),e&&e.trim()!==""&&await this.playFromUrl(e)?!0:this.playWithSpeechSynthesis(t)}catch(r){return console.error("Pronunciation error:",r),!1}}async playFromUrl(t){return new Promise(e=>{try{this.currentAudio=new Audio(t),this.currentAudio.addEventListener("ended",()=>{this.currentAudio=null,e(!0)}),this.currentAudio.addEventListener("error",r=>{console.warn("Audio URL playback failed:",r),this.currentAudio=null,e(!1)}),this.currentAudio.play()}catch(r){console.warn("Audio playback error:",r),e(!1)}})}playWithSpeechSynthesis(t){return new Promise(e=>{try{if(!("speechSynthesis"in window)){console.warn("Speech synthesis not supported"),e(!1);return}const r=new SpeechSynthesisUtterance(t);r.lang="en-US",r.rate=.9,r.pitch=1,r.onend=()=>e(!0),r.onerror=n=>{console.error("Speech synthesis error:",n),e(!1)},window.speechSynthesis.speak(r)}catch(r){console.error("Speech synthesis error:",r),e(!1)}})}stopCurrentAudio(){this.currentAudio&&(this.currentAudio.pause(),this.currentAudio=null),"speechSynthesis"in window&&window.speechSynthesis.cancel()}async validateAudioUrl(t){if(!t||t.trim()==="")return!1;try{return(await fetch(t,{method:"HEAD"})).ok}catch{return!1}}}const S=new f;class p{async fetchWordData(t){try{const e=await fetch(`${h.DICTIONARY}${encodeURIComponent(t)}`);if(!e.ok)return console.warn(`Word "${t}" not found in dictionary`),null;const r=await e.json();return this.parseApiResponse(r,t)}catch(e){return console.error("Dictionary API error:",e),null}}parseApiResponse(t,e){if(!t||t.length===0)return null;const r=t[0],n=r.phonetics||[],i=r.meanings||[],s=this.extractIPA(n),o=this.extractAudio(n),{definition:l,examples:d}=this.extractMeaningAndExamples(i),A=`${h.YOUGLISH_BASE}${encodeURIComponent(e)}/english`;return{word:r.word||e,meaning:l,examples:d,ipa:s,audioUrl:o,youglishLink:A,interval:0,repetition:0,easeFactor:2.5,nextReview:null,lastReview:null}}extractIPA(t){for(const e of t)if(e.text)return e.text;return""}extractAudio(t){for(const e of t)if(e.audio&&e.audio.trim()!=="")return e.audio;return""}extractMeaningAndExamples(t){let e="",r=[];if(t.length>0){const n=t[0];if(n.definitions&&n.definitions.length>0){const i=n.definitions[0];e=`(${n.partOfSpeech}) ${i.definition}`;for(let s=0;s<Math.min(3,n.definitions.length);s++){const o=n.definitions[s];o.example&&r.push(o.example)}}}return r.length===0&&(r=["No example available"]),{definition:e,examples:r}}createManualEntry(t,e="",r=[]){const n=`${h.YOUGLISH_BASE}${encodeURIComponent(t)}/english`;return{word:t,meaning:e||"User-defined word",examples:r.length>0?r:["No example available"],ipa:"",audioUrl:"",youglishLink:n,interval:0,repetition:0,easeFactor:2.5,nextReview:null,lastReview:null,isManual:!0}}}const v=new p;export{g as a,v as d,S as p,I as s};
